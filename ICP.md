## 简介

ICP算法开始于两个网格和一个初始的刚体变换。然后会依次在网格上选择对应点，逐步修正这个变换，以找到最好的位移和旋转变换，来最小化测度误差。



ICP算法是一个非线性区域搜索算法。它有收敛速度慢，掉进local minima的趋势。因此点的选择策略和误差测度的选择很重要。有另一篇论文介绍了一些方法。

S. Rusinkiewicz and M. Levoy. Efficient variants of the ICP
algorithm. Proc. 3DIM, 2001.



来自数据的噪声，会影响ICP的收敛。并且点对面计算误差比点对点更好。



#### 误差定义

设P,Q是两个网格的带有法向量的点集。对于每一对点（pi,qi）有误差

$E = \sum^k_{i=1}((p_i-q_i)\cdot n_i+r\cdot(p_i\times n_i)+t\cdot n_i)^2$ （1）

其中ni是qi的法向量。

$r=(r_x,r_y,r_z),t=(t_x,t_y,t_z)$ 。 r是在三个坐标上的旋转矢量，t是平移矢量。

![1](https://github.com/freyakniglty/algorithm/blob/master/images/icp1.jpg)

我们可以这么来理解以上公式：

对每一对（pi,qi）施加在平面P上一个在ni方向上的平移的力，以及一个环绕在轴 $p_i\times n_i$ 上面的扭转力。最后两项显示，如果给定一对点i,被一个变换矢量$[\Delta r^T \Delta t^T]$ 改变，则点-平面的距离会改变：

$\Delta d_i = [\Delta r^T \Delta t^T]\begin{bmatrix}p_i\times n_i\\n_i\end{bmatrix}$



#### 解线性方程组

对公式（1）求偏微分。结果是这个线性方程组的解：$Cx = b$

这里x是一个6x1的变换参数，b是一个残差向量，C是对于每个点的一个6x6的关于扭转力和平移力的协方差矩阵。

$C = FF^T = \begin{bmatrix}p_1\times n_1&...&p_k\times n_k\\ n_1&...&n_k\end{bmatrix}\begin{bmatrix}(p_1 \times n_1)^T &n_1^T\\...&...\\(p_k\times n_k)^T&n_k^T\end{bmatrix}$   (2)



C表示当P由$[\Delta r^T \Delta t^T]$被移动到Q（Q平面的误差为0）误差的改变量。

则有：

$\Delta E=[\Delta r^T \Delta t^T] C\begin{bmatrix}\Delta r\\\Delta t\end{bmatrix}$





#### 非稳定问题

为了更稳定，可以将C表示为它的特征向量和它的特征值。如果特征值很小，相应的特征向量定义了一个变换，如果移动（并非到最佳位置）两个网格产生的误差也会很小。

![2](https://github.com/freyakniglty/algorithm/blob/master/images/icp1.jpg)

所以需要识别不稳定的旋转和平移，看有没有特征能更好地约束不稳定的变换，然后对这样的特征进行取样。



#### 通过取样选择来提升ICP的稳定性

这里介绍一个贪婪算法。这个算法的目标是当排列快接近于正确的位置，选择能够约束变换的特征取样。

##### 建立稳定性的测度

让$x_1,x_2...x_6$ 为C的特征向量，有特征值 $\lambda_1 \ge...\ge\lambda_6$ 

每一个特征向量对应一个可以被描述为旋转或者平移的动作。如果有$\lambda_k$ 和$\lambda_1$ 比较起来很小，相应的特征向量对应一个滑动的方向。因此，我们根据$c=\frac{\lambda_1}{\lambda_6}$ 来考虑稳定性。取样策略的目标就是让c能接近于1。

先要做一个改变比例的处理，让pi到原点距离的均值为1.这样就能让旋转与平移的影响相等。

因为我们是操作P接近Q，则只需要考虑P的C矩阵，点和向量都来自于P。记为$C_P$

##### Optimizing

先用（2）来计算出C。然后我们由以下得到一个协方差矩阵的预估：

**A1** 让$S_P$ 为一个随机在P上选择的点的集合。规定$S_P$ 的大小，这样一旦非重合区域的点被抛弃，有足够的点去决定协方差矩阵。这个大小取决于重合区域的大小，分辨率的大小，和噪声大小。

**A2** 对于每一个点 $p\in S_P$ 首先要判断它是否在重合区域，我们找到离它最近的在Q上的点q,然后检查它是否在边界上。如果qi在边界，则p在重合区域之外我们丢弃这个它。否则，就加入到重合集合$O_P$

**A3** 我们从$O_P$ 里的点建立$C_P$ 计算出特征向量 $x_1,...x_6$ 。是根据（2）来计算的，点和法向量都取自P。

  

然后去优化取样

**B1** 记S为候选点的集合。理想情况下，S包含了所有P里面属于重合区域的点。创建一个六维向量

$v_i = [p_i\times n_i^P,n_i^P]$  对于在S中任意一个点。$n_i^P$ 是点pi的法向量。

**B2** 对于排好序的列表 $L_1...L_6$ , 每一个列表$L_k$ 包含向量vi，按照$v_i\cdot x_k$ 的降序排列。这个排序的意义是，看pi在什么程度上约束特征向量xk，也就是对于整个网格的几何稳定性。

**B3**  让$t_1...t_6$ 表示 $(v_i\cdot x_k)^2$ 的和。$(v_i\cdot x_k)^2$ 表示如果pi从最佳位置被xk移动的不好的位置所导致的误差量。然后在候选点里选择下一个达到最小的值的点。这是一个贪婪算法。

**B4** 令p为选择的点。对于每一个xk计算 $(v_i\cdot x_k)^2$ 然后更新误差总量。



等从P取样完成后，我们可以计算离Q最近的点。然后按照剩下的ICP算法的常规步骤走，现在使用的是Q上的点的法向量了。



可以用k-d tree 结构来加速算法。







